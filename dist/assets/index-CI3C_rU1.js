(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))i(n);new MutationObserver(n=>{for(const a of n)if(a.type==="childList")for(const o of a.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function e(n){const a={};return n.integrity&&(a.integrity=n.integrity),n.referrerPolicy&&(a.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?a.credentials="include":n.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function i(n){if(n.ep)return;n.ep=!0;const a=e(n);fetch(n.href,a)}})();const v="https://fbyfbvxwbyksnvibyypu.supabase.co",S="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZieWZidnh3Ynlrc252aWJ5eXB1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1MDc0MjksImV4cCI6MjA4MDA4MzQyOX0.IKTvSGWXVKLJHNw1sUjed3h9W5jTMnMhWUzv14v2xyQ";console.log("üöÄ Starting Supabase initialization...");let k,p;try{if(!window.supabase||!window.supabase.createClient)throw console.error("‚ùå Supabase JS library not loaded!"),new Error("Supabase JS library not found");console.log("üì¶ Supabase library found, creating client..."),k=window.supabase.createClient(v,S,{auth:{persistSession:!1,autoRefreshToken:!1},db:{schema:"public"},global:{headers:{"Content-Type":"application/json"}}}),console.log("‚úÖ Supabase client created");class s{constructor(){this.client=k,this.isConnected=!1,this.connectionChecked=!1,console.log("üîÑ SupabaseService instance created")}async checkConnection(){if(this.connectionChecked)return console.log("üì° Connection already checked"),this.isConnected;console.log("üîå Checking Supabase connection...");try{const{data:e,error:i}=await this.client.from("notes").select("count",{count:"exact",head:!0}).limit(1);return i?(console.error("‚ùå Connection test failed:",i.message),this.isConnected=!1):(console.log("‚úÖ Connection test successful"),this.isConnected=!0),this.connectionChecked=!0,this.isConnected}catch(e){return console.error("‚ùå Connection error:",e.message),this.isConnected=!1,this.connectionChecked=!0,!1}}async getNotes(){if(!await this.checkConnection())return console.warn("‚ö†Ô∏è Supabase not connected, returning empty array"),[];console.log("üì• Fetching notes from Supabase...");try{const{data:i,error:n}=await this.client.from("notes").select("*").order("created_at",{ascending:!1});return n?(console.error("‚ùå Error fetching notes:",n),[]):(console.log(`‚úÖ Loaded ${i?.length||0} notes`),i||[])}catch(i){return console.error("‚ùå Failed to fetch notes:",i),[]}}async addNote(e){if(!await this.checkConnection())throw new Error("‚ùå Supabase not connected");console.log("üíæ Saving note to Supabase...");const n={title:e.title?.trim()||"",subject:e.subject||"other",content:e.content?.trim()||"",author:e.author?.trim()||"Anonim",likes_count:parseInt(e.likes)||0,dislikes_count:parseInt(e.dislikes)||0};e.image&&e.image!=="null"&&(n.image_url=e.image);try{const{data:a,error:o}=await this.client.from("notes").insert([n]).select();if(o)throw console.error("‚ùå Error adding note:",o),new Error(`Failed to save: ${o.message}`);return console.log(`‚úÖ Note saved with ID: ${a[0]?.id}`),a[0]}catch(a){throw console.error("‚ùå Failed to add note:",a),a}}async deleteNote(e){if(!await this.checkConnection())throw new Error("‚ùå Supabase not connected");console.log(`üóëÔ∏è Deleting note: ${e}`);try{const{error:n}=await this.client.from("likes").delete().eq("note_id",e);n&&console.warn("‚ö†Ô∏è Error deleting likes:",n.message);const{error:a}=await this.client.from("comments").delete().eq("note_id",e);a&&console.warn("‚ö†Ô∏è Error deleting comments:",a.message);const{error:o}=await this.client.from("notes").delete().eq("id",e);if(o)throw console.error("‚ùå Error deleting note:",o),o;return console.log("‚úÖ Note and all related data deleted"),!0}catch(n){throw console.error("‚ùå Failed to delete note:",n),n}}async getLikes(e){if(!await this.checkConnection())return[];try{const{data:n,error:a}=await this.client.from("likes").select("*").eq("note_id",e);return a?(console.error("‚ùå Error fetching likes:",a),[]):n||[]}catch(n){return console.error("‚ùå Failed to fetch likes:",n),[]}}async toggleLike(e,i,n="like"){if(!await this.checkConnection())throw new Error("‚ùå Supabase not connected");try{const{data:o,error:r}=await this.client.from("likes").select("*").eq("note_id",e).eq("user_id",i).maybeSingle();if(r&&r.code!=="PGRST116")throw console.error("‚ùå Error checking reaction:",r),r;if(o)if(o.type===n){const{error:c}=await this.client.from("likes").delete().eq("id",o.id);if(c)throw c;return{reaction:null,type:"removed"}}else{const{data:c,error:l}=await this.client.from("likes").update({type:n}).eq("id",o.id).select();if(l)throw l;return{reaction:c[0],type:"updated"}}else{const{data:c,error:l}=await this.client.from("likes").insert([{note_id:e,user_id:i,type:n}]).select();if(l)throw l;return{reaction:c[0],type:"added"}}}catch(o){throw console.error("‚ùå Failed to toggle like:",o),o}}async getComments(e){if(!await this.checkConnection())return[];try{const{data:n,error:a}=await this.client.from("comments").select("*").eq("note_id",e).order("created_at",{ascending:!0});return a?(console.error("‚ùå Error fetching comments:",a),[]):n||[]}catch(n){return console.error("‚ùå Failed to fetch comments:",n),[]}}async addComment(e){if(!await this.checkConnection())throw new Error("‚ùå Supabase not connected");console.log("üí¨ Adding comment to Supabase...");try{const{data:n,error:a}=await this.client.from("comments").insert([{note_id:e.noteId,author:e.author?.trim()||"Anonim",text:e.text?.trim()||""}]).select();if(a)throw console.error("‚ùå Error adding comment:",a),a;return console.log("‚úÖ Comment saved"),n[0]}catch(n){throw console.error("‚ùå Failed to add comment:",n),n}}async updateNoteStats(e,i,n){if(!await this.checkConnection())return!1;try{const{error:o}=await this.client.from("notes").update({likes_count:parseInt(i)||0,dislikes_count:parseInt(n)||0}).eq("id",e);return o?(console.error("‚ùå Error updating note stats:",o),!1):!0}catch(o){return console.error("‚ùå Failed to update note stats:",o),!1}}async getTotalLikes(){if(!await this.checkConnection())return 0;try{const{data:i,error:n}=await this.client.from("notes").select("likes_count");return n?0:i.reduce((a,o)=>a+(o.likes_count||0),0)}catch{return 0}}async getTotalComments(){if(!await this.checkConnection())return 0;try{const{count:i,error:n}=await this.client.from("comments").select("*",{count:"exact",head:!0});return n?0:i||0}catch{return 0}}}p=new s,console.log("‚úÖ SupabaseService initialized"),setTimeout(async()=>{console.log("üß™ Testing connection after initialization...");const t=await p.checkConnection();console.log(`üìä Final connection status: ${t?"‚úÖ Connected":"‚ùå Not Connected"}`)},1e3)}catch(s){console.error("‚ùå Failed to initialize Supabase:",s),p={client:null,isConnected:!1,connectionChecked:!0,checkConnection:async()=>(console.log("‚ö†Ô∏è Fallback service - no connection"),!1),getNotes:async()=>(console.log("‚ö†Ô∏è Fallback service - returning empty notes"),[]),addNote:async()=>{throw console.log("‚ö†Ô∏è Fallback service - cannot add note"),new Error("Supabase not available")},deleteNote:async()=>{throw console.log("‚ö†Ô∏è Fallback service - cannot delete note"),new Error("Supabase not available")},getLikes:async()=>[],toggleLike:async()=>{throw new Error("Supabase not available")},getComments:async()=>[],addComment:async()=>{throw new Error("Supabase not available")},updateNoteStats:async()=>!1,getTotalLikes:async()=>0,getTotalComments:async()=>0}}window.supabaseService=p;console.log("‚úÖ Supabase service exposed to window");class u{static show(t,e="info",i=3e3){const n=document.querySelector(".custom-alert");n&&n.remove();const a=document.createElement("div");a.className=`custom-alert custom-alert-${e}`;let o,r,c,l;switch(e){case"success":o="rgba(16, 185, 129, 0.1)",r="#10b981",c="#10b981",l="‚úì";break;case"error":o="rgba(239, 68, 68, 0.1)",r="#ef4444",c="#ef4444",l="‚úó";break;case"warning":o="rgba(245, 158, 11, 0.1)",r="#f59e0b",c="#f59e0b",l="‚ö†";break;default:o="rgba(74, 144, 226, 0.1)",r="#4a90e2",c="#4a90e2",l="‚Ñπ";break}return a.style.cssText=`
            position: fixed; top: 20px; right: 20px; background: ${o}; color: ${r}; border: 1px solid ${c};
            padding: 16px 20px; border-radius: 12px; display: flex; align-items: center; gap: 12px; z-index: 9999;
            backdrop-filter: blur(10px); box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15); max-width: 400px;
            animation: slideInRight 0.3s ease-out; transition: all 0.3s ease;
        `,a.innerHTML=`
            <span class="alert-icon" style="font-size: 1.2rem;">${l}</span>
            <span class="alert-message">${t}</span>
            <button class="alert-close" style="background: none; border: none; color: ${r}; font-size: 1.5rem; cursor: pointer; margin-left: auto; padding: 0; line-height: 1;">√ó</button>
        `,document.body.appendChild(a),a.querySelector(".alert-close").addEventListener("click",()=>{a.style.animation="slideOutRight 0.3s ease-out",setTimeout(()=>a.remove(),300)}),i>0&&setTimeout(()=>{a.parentNode&&(a.style.animation="slideOutRight 0.3s ease-out",setTimeout(()=>a.remove(),300))},i),a}}class m{static show(t="Memproses..."){this.hide();const e=document.createElement("div");if(e.id="loading-spinner",e.style.cssText=`
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.9);
            display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; backdrop-filter: blur(5px);
        `,e.innerHTML=`
            <div class="spinner-container" style="text-align: center; padding: 2rem; border-radius: 20px; background: linear-gradient(135deg, rgba(74, 144, 226, 0.1) 0%, rgba(123, 184, 241, 0.1) 100%); border: 1px solid rgba(74, 144, 226, 0.2); box-shadow: 0 10px 30px rgba(74, 144, 226, 0.2);">
                <div class="spinner" style="width: 60px; height: 60px; border: 4px solid rgba(74, 144, 226, 0.1); border-top: 4px solid #4a90e2; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
                <p style="color: #4a90e2; font-size: 1.1rem; font-weight: 500; margin: 0;">${t}</p>
            </div>
        `,document.body.appendChild(e),!document.querySelector("#spinner-animation")){const i=document.createElement("style");i.id="spinner-animation",i.textContent="@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } } @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } } @keyframes slideOutRight { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }",document.head.appendChild(i)}}static hide(){const t=document.getElementById("loading-spinner");t&&(t.style.animation="fadeOut 0.3s ease-out",setTimeout(()=>t.remove(),300))}}const g={formatDate(s){try{return new Date(s).toLocaleDateString("id-ID",{day:"numeric",month:"long",year:"numeric",hour:"2-digit",minute:"2-digit"})}catch{return""}},createNoteCard(s){const t=d.getLikeStatus(s.id),e=d.getComments(s.id),i=document.createElement("div");i.className="note-card",i.setAttribute("data-note-id",s.id);let n="";return s.image&&(n+=`
                <div class="note-media">
                    <img src="${s.image}" alt="Foto catatan" class="note-image" onclick="openImageModal('${s.image}')">
                    <div class="image-actions">
                        <button class="image-action-btn" onclick="openImageModal('${s.image}')" title="Lihat gambar">üîç</button>
                        <button class="image-action-btn" onclick="downloadImageFromUrl('${s.image}', '${s.title}.jpg')" title="Download gambar">‚¨áÔ∏è</button>
                    </div>
                </div>
            `),i.innerHTML=`
            <div class="note-header">
                <h3 class="note-title">${this.escapeHtml(s.title)}</h3>
                <span class="subject-tag">${this.getSubjectName(s.subject)}</span>
            </div>
            <div class="note-content">${this.escapeHtml(s.content)}</div>
            ${n}
            <div class="note-meta">
                <span class="author">${this.escapeHtml(s.author)}</span>
                <span class="date">${this.formatDate(s.date)}</span>
            </div>
            <div class="like-dislike">
                <button class="like-btn ${t.liked?"active":""}" data-note-id="${s.id}" onclick="handleLike('${s.id}')">
                    üëç Like <span class="like-count">${s.likes}</span>
                </button>
                <button class="dislike-btn ${t.disliked?"active":""}" data-note-id="${s.id}" onclick="handleDislike('${s.id}')">
                    üëé Dislike <span class="dislike-count">${s.dislikes}</span>
                </button>
            </div>
            <div class="comments-section">
                <h4>Komentar (${e.length})</h4>
                <div class="comments-list">
                    ${e.map(a=>`<div class="comment"><p><strong>${this.escapeHtml(a.author)}:</strong> ${this.escapeHtml(a.text)}</p><small>${this.formatDate(a.date)}</small></div>`).join("")}
                </div>
                <div class="comment-input-group">
                    <input type="text" class="comment-author" placeholder="Nama Anda" required>
                    <div class="comment-form-container">
                        <input type="text" placeholder="Tulis komentar..." class="comment-input">
                        <button class="comment-submit" onclick="handleAddComment('${s.id}', this)">Kirim</button>
                    </div>
                </div>
            </div>
        `,i},getSubjectName(s){return{"bahasa-arab":"Bahasa Arab",nahwu:"Nahwu",shorof:"Shorof",tahfidz:"Tahfidz",tahsin:"Tahsin",aqidah:"Aqidah",fikih:"Fikih",hadits:"Hadits","adab-akhlaq":"Adab & Akhlaq","bahasa-inggris":"Bahasa Inggris",matematika:"Matematika",bootcamp:"Bootcamp"}[s]||s},escapeHtml(s){if(!s)return"";const t=document.createElement("div");return t.textContent=s,t.innerHTML},renderNoteOfTheDay(s){const t=document.getElementById("noteOfDayContainer");if(!t)return;if(!s){t.innerHTML='<div class="noteday-card"><p class="empty">Belum ada catatan.</p></div>';return}const e=d.getComments(s.id);t.innerHTML=`
        <div class="noteday-card">
            <div class="noteday-header">
                <span class="subject-tag large">${this.getSubjectName(s.subject)}</span>
                <span class="date">${this.formatDate(s.date)}</span>
            </div>
            <h3>${this.escapeHtml(s.title)}</h3>
            
            <!-- Menggunakan class note-content agar format baris baru terbaca -->
            <div class="note-content full-text">${this.escapeHtml(s.content)}</div>
            
            <div class="noteday-stats">
                <span>üëç ${s.likes}</span>
                <span>üí¨ ${e.length}</span>
                <span>‚úçÔ∏è ${this.escapeHtml(s.author)}</span>
            </div>
            <button class="btn-primary" onclick="scrollToNote('${s.id}')">Lihat Lengkap</button>
        </div>
    `},renderTrendingSection(s){const t=document.getElementById("trendingContainer");if(t){if(s.length===0){t.innerHTML='<p class="empty">Belum ada catatan trending.</p>';return}t.innerHTML=s.map(e=>`
            <div class="trending-item" onclick="scrollToNote('${e.id}')">
                <h4>${this.escapeHtml(e.title.substring(0,40))}...</h4>
                <div class="trending-meta"><span>${this.getSubjectName(e.subject)}</span><span>üëç ${e.likes}</span></div>
            </div>
        `).join("")}},renderCategories(){const s=document.getElementById("categoriesContainer");if(!s)return;const t=d.getCategories();if(t.length===0){s.innerHTML='<p class="empty">Belum ada kategori.</p>';return}s.innerHTML=t.map(e=>`
            <div class="category-card" data-subject="${e.id}" onclick="filterBySubject('${e.id}')">
                <div class="category-icon">${e.name.charAt(0)}</div><h4>${e.name}</h4><p>${e.count} catatan</p>
            </div>
        `).join("")},renderActivityFeed(s){const t=document.getElementById("activityFeed");if(t){if(s.length===0){t.innerHTML='<p class="empty">Belum ada aktivitas.</p>';return}t.innerHTML=s.map(e=>`<div class="activity-item"><span>${e.text}</span><small>${e.timeAgo}</small></div>`).join("")}},renderNotes(s,t){t.innerHTML="";const e=document.getElementById("noNotes");if(s.length===0){e&&(e.style.display="block");return}e&&(e.style.display="none"),s.forEach(i=>{t.appendChild(this.createNoteCard(i))})}};class C{constructor(){this.notes=[],this.likes={},this.comments={},this.userLikes={},this.supabaseService=null,this.initialized=!1,this.init()}async init(){console.log("üìö Initializing NotesManager..."),typeof m<"u"&&m.show("Menghubungkan ke server..."),await this.waitForSupabaseClient(),this.supabaseService?(console.log("‚úÖ Supabase client ready, attempting to fetch data..."),await this.fetchWithRetry()):(console.warn("‚ö†Ô∏è Supabase not available, using empty mode."),this.notes=[],this.initialized=!0,typeof m<"u"&&m.hide())}async waitForSupabaseClient(){return new Promise(t=>{let e=0;const i=100,n=()=>{window.supabaseService&&window.supabaseService.client?(this.supabaseService=window.supabaseService,t(!0)):e<i?(e++,setTimeout(n,100)):t(!1)};n()})}async fetchWithRetry(){let t=0;const e=5;let i=!1;for(;t<e&&!i;)try{if(t>0&&typeof m<"u"){const a=document.querySelector("#loading-spinner p");a&&(a.textContent=`Membangunkan database... (${t}/${e})`)}if(console.log(`üîÑ Percobaan fetch data ke-${t+1}...`),await this.supabaseService.checkConnection())await this.loadFromSupabase(),i=!0,console.log("‚úÖ Data berhasil diambil!");else throw new Error("Database belum siap")}catch{console.warn(`‚ö†Ô∏è Percobaan ${t+1} gagal.`),t++,t<e&&await new Promise(a=>setTimeout(a,1500))}this.initialized=!0,typeof m<"u"&&m.hide(),h(),!i&&typeof u<"u"&&u.show("Koneksi lambat. Refresh jika data kosong.","warning",5e3)}async loadFromSupabase(){const t=await this.supabaseService.getNotes();if(!t){this.notes=[];return}this.notes=t.map(e=>({id:e.id,title:this.sanitizeHTML(e.title||""),subject:this.sanitizeHTML(e.subject||"other"),content:this.sanitizeHTML(e.content||""),author:this.sanitizeHTML(e.author||"Anonim"),date:e.created_at||new Date().toISOString(),likes:e.likes_count||0,dislikes:e.dislikes_count||0,image:e.image_url||null})),await this.loadAdditionalData()}async loadAdditionalData(){if(!this.supabaseService||!this.supabaseService.isConnected)return;const t=this.notes.map(async e=>{try{const[i,n]=await Promise.all([this.supabaseService.getLikes(e.id),this.supabaseService.getComments(e.id)]),a=this.getUserId(),o=i.find(r=>r.user_id===a);this.likes[e.id]={liked:o?.type==="like",disliked:o?.type==="dislike",count:e.likes||0,dislikes:e.dislikes||0},this.userLikes[e.id]=this.userLikes[e.id]||{},this.userLikes[e.id][a]=o?o.type:"none",this.comments[e.id]=n.map(r=>({id:r.id,author:this.sanitizeHTML(r.author||"Anonim"),text:this.sanitizeHTML(r.text||""),date:r.created_at}))}catch{this.likes[e.id]={liked:!1,disliked:!1,count:e.likes||0,dislikes:e.dislikes||0},this.comments[e.id]=[]}});await Promise.allSettled(t)}sanitizeHTML(t){const e=document.createElement("div");return e.textContent=t,e.innerHTML}escapeHtml(t){return this.sanitizeHTML(t)}getUserId(){let t=localStorage.getItem("user_id");return t||(t="user_"+Math.random().toString(36).substr(2,9),localStorage.setItem("user_id",t)),t}getNoteOfTheDay(){if(this.notes.length===0)return null;const t=new Date().toDateString().split("").reduce((i,n)=>i+n.charCodeAt(0),0),e=this.getFilteredAndSortedNotes("all","likes");return e[t%Math.max(1,e.length)]}getTrendingNotes(t=5){const e=Date.now(),i=1440*60*1e3;return this.notes.filter(n=>new Date(n.date)>new Date(e-i)).map(n=>({...n,score:n.likes*.7+(this.comments[n.id]?.length||0)*.3})).sort((n,a)=>a.score-n.score).slice(0,t).concat(this.notes.slice(0,t)).slice(0,t)}getCategories(){return[{id:"matematika",name:"Matematika"},{id:"bahasa-inggris",name:"Bahasa Inggris"},{id:"bahasa-arab",name:"Bahasa Arab"},{id:"fikih",name:"Fikih"},{id:"aqidah",name:"Aqidah"},{id:"hadits",name:"Hadits"},{id:"adab-akhlaq",name:"Adab & Akhlaq"},{id:"nahwu",name:"Nahwu"},{id:"shorof",name:"Shorof"},{id:"tahfidz",name:"Tahfidz"},{id:"tahsin",name:"Tahsin"},{id:"bootcamp",name:"Bootcamp"}].map(e=>({...e,count:this.notes.filter(i=>i.subject===e.id).length})).filter(e=>e.count>0)}getRecentActivity(t=5){const e=[];return this.notes.slice(0,10).forEach(i=>{e.push({type:"upload",text:`Catatan baru: "${i.title.substring(0,30)}..."`,time:new Date(i.date).getTime(),noteId:i.id});const n=this.comments[i.id]?.[this.comments[i.id].length-1];n&&e.push({type:"comment",text:`Komentar di "${i.title.substring(0,20)}..."`,time:new Date(n.date).getTime(),noteId:i.id})}),e.sort((i,n)=>n.time-i.time).slice(0,t).map(i=>({...i,timeAgo:this.getTimeAgo(Date.now()-i.time)}))}getTimeAgo(t){const e=Math.floor(t/1e3),i=Math.floor(e/60),n=Math.floor(i/60),a=Math.floor(n/24);return a>0?`${a} hari lalu`:n>0?`${n} jam lalu`:i>0?`${i} menit lalu`:`${e} detik lalu`}getTotalSubjects(){return new Set(this.notes.map(t=>t.subject)).size}getTotalNotes(){return this.notes.length}async addNote(t,e,i,n="Anonim",a=null){const o={title:this.sanitizeHTML(t.trim()),subject:e,content:this.sanitizeHTML(i.trim()),author:this.sanitizeHTML(n.trim())||"Anonim",date:new Date().toISOString(),likes:0,dislikes:0,image:a};if(this.supabaseService&&this.supabaseService.isConnected){const r=await this.supabaseService.addNote(o);return o.id=r.id,this.notes.unshift(o),o}else throw new Error("Tidak terhubung ke server")}getLikeStatus(t){const e=this.getUserId(),i=this.userLikes[t]?.[e]||"none",n=this.notes.find(a=>a.id===t);return{liked:i==="like",disliked:i==="dislike",count:n?.likes||0,dislikes:n?.dislikes||0}}async toggleLike(t){const e=this.notes.find(o=>o.id===t);if(!e)return null;const i=this.getUserId(),n=this.getLikeStatus(t);n.liked?(e.likes--,delete this.userLikes[t][i]):(n.disliked&&e.dislikes--,e.likes++,this.userLikes[t]=this.userLikes[t]||{},this.userLikes[t][i]="like");const a=this.getLikeStatus(t);if(this.likes[t]=a,this.supabaseService?.isConnected)try{await this.supabaseService.toggleLike(t,i,"like"),await this.supabaseService.updateNoteStats(t,e.likes,e.dislikes),u.show(n.liked?"Like dihapus":"Liked!","success",2e3)}catch{u.show("Gagal sinkron","warning")}return a}async toggleDislike(t){const e=this.notes.find(o=>o.id===t);if(!e)return null;const i=this.getUserId(),n=this.getLikeStatus(t);n.disliked?(e.dislikes--,delete this.userLikes[t][i]):(n.liked&&e.likes--,e.dislikes++,this.userLikes[t]=this.userLikes[t]||{},this.userLikes[t][i]="dislike");const a=this.getLikeStatus(t);if(this.likes[t]=a,this.supabaseService?.isConnected)try{await this.supabaseService.toggleLike(t,i,"dislike"),await this.supabaseService.updateNoteStats(t,e.likes,e.dislikes),u.show(n.disliked?"Dislike dihapus":"Disliked!","success",2e3)}catch{u.show("Gagal sinkron","warning")}return a}getComments(t){return this.comments[t]||[]}async addComment(t,e,i="Anonim"){this.comments[t]||(this.comments[t]=[]);const n={noteId:t,author:this.sanitizeHTML(i.trim())||"Anonim",text:this.sanitizeHTML(e.trim()),date:new Date().toISOString()};if(this.supabaseService?.isConnected){const a=await this.supabaseService.addComment(n);n.id=a.id,this.comments[t].push(n),u.show("Komentar terkirim!","success",2e3)}else throw new Error("Offline");return n}getFilteredAndSortedNotes(t="all",e="likes"){let i=[...this.notes];return t!=="all"&&(i=i.filter(n=>n.subject===t)),e==="likes"?i.sort((n,a)=>a.likes-n.likes):e==="recent"?i.sort((n,a)=>new Date(a.date)-new Date(n.date)):e==="oldest"&&i.sort((n,a)=>new Date(n.date)-new Date(a.date)),i}isInitialized(){return this.initialized}async refreshData(){return this.fetchWithRetry()}}const d=new C;let f="";function L(s){f=s,document.getElementById("modalImage").src=s,document.getElementById("imageModal").classList.add("show"),document.body.style.overflow="hidden"}function E(){document.getElementById("imageModal").classList.remove("show"),document.body.style.overflow=""}function I(){f&&w(f)}function w(s,t="download.jpg"){const e=document.createElement("a");e.href=s,e.download=t,document.body.appendChild(e),e.click(),document.body.removeChild(e)}async function M(){m.show("Menyinkronkan data...");try{await d.refreshData(),u.show("Data disinkronkan!","success")}catch{u.show("Gagal sinkronisasi","error")}}async function T(s){await d.toggleLike(s)&&h()}async function $(s){await d.toggleDislike(s)&&h()}async function B(s,t){const e=t.closest(".comment-input-group"),i=e.querySelector(".comment-author").value,n=e.querySelector(".comment-input").value;if(!i||!n)return u.show("Isi nama dan komentar!","warning");try{await d.addComment(s,n,i),h(),e.querySelector(".comment-input").value=""}catch(a){u.show(a.message,"error")}}function x(s){const t=document.getElementById("subjectFilter");t&&(t.value=s,h(),document.getElementById("notesContainer").scrollIntoView({behavior:"smooth"}))}function N(s){const t=document.querySelector(`[data-note-id="${s}"]`);t&&(t.scrollIntoView({behavior:"smooth"}),t.style.animation="none",setTimeout(()=>t.style.animation="fadeIn 0.5s ease",10))}function D(){const s=document.getElementById("fileUploadArea"),t=document.getElementById("noteImage"),e=document.getElementById("imagePreview"),i=document.getElementById("uploadPlaceholder"),n=document.getElementById("removeImageBtn");!s||!t||(t.addEventListener("change",a=>{const o=a.target.files[0];if(o){if(o.size>5*1024*1024){u.show("Ukuran file terlalu besar! Maksimal 5MB.","warning"),t.value="";return}const r=new FileReader;r.onload=c=>{e.innerHTML=`<img src="${c.target.result}" alt="Preview">`,e.style.display="flex",i.style.display="none",n&&(n.style.display="block")},r.readAsDataURL(o)}}),n&&n.addEventListener("click",()=>{t.value="",e.innerHTML="",e.style.display="none",i.style.display="block",n.style.display="none"}))}async function A(s){s.preventDefault();const t=document.getElementById("noteTitle").value,e=document.getElementById("noteSubject").value,i=document.getElementById("noteContent").value,n=document.getElementById("authorName").value,a=document.getElementById("noteImage"),o=a?a.files[0]:null;if(!t||!e||!i||!n)return u.show("Harap isi Judul, Mata Pelajaran, Konten, dan Nama Penulis!","warning");m.show("Mengupload catatan...");const r=async c=>{try{await d.addNote(t,e,i,n,c),m.hide(),u.show("Berhasil upload!","success");const l=document.getElementById("uploadSuccess");l&&l.classList.add("show"),s.target.reset(),document.getElementById("imagePreview").style.display="none",document.getElementById("uploadPlaceholder").style.display="block";const y=document.getElementById("removeImageBtn");y&&(y.style.display="none")}catch(l){m.hide(),u.show("Gagal Upload: "+l.message,"error")}};if(o){const c=new FileReader;c.onload=l=>r(l.target.result),c.onerror=()=>{m.hide(),u.show("Gagal membaca file gambar","error")},c.readAsDataURL(o)}else r(null)}function h(){const s=document.getElementById("notesContainer");if(s&&d.isInitialized()){const t=document.getElementById("subjectFilter")?.value||"all",e=document.getElementById("sortFilter")?.value||"likes",i=d.getFilteredAndSortedNotes(t,e);g.renderNotes(i,s),F()}else setTimeout(h,500)}function F(){const s=document.getElementById("totalNotesCount");s&&(s.textContent=d.getTotalNotes());const t=document.getElementById("totalSubjectsCount");t&&(t.textContent=d.getTotalSubjects()),g.renderNoteOfTheDay(d.getNoteOfTheDay()),g.renderTrendingSection(d.getTrendingNotes()),g.renderCategories(),g.renderActivityFeed(d.getRecentActivity())}function j(){document.getElementById("subjectFilter")&&(document.getElementById("subjectFilter").value="all"),document.getElementById("sortFilter")&&(document.getElementById("sortFilter").value="likes"),h()}function b(){const s=document.getElementById("featuredSection");s.style.display==="none"?(s.style.display="block",s.classList.add("show")):(s.style.display="none",s.classList.remove("show"))}document.addEventListener("DOMContentLoaded",()=>{console.log("üöÄ App Loaded"),document.getElementById("notesContainer")&&(document.getElementById("subjectFilter")?.addEventListener("change",h),document.getElementById("sortFilter")?.addEventListener("change",h),document.getElementById("featuredMenuBtn")?.addEventListener("click",b),h());const s=document.getElementById("uploadForm");s&&(s.addEventListener("submit",A),D())});window.forceRefreshAll=M;window.resetFilters=j;window.handleLike=T;window.handleDislike=$;window.handleAddComment=B;window.filterBySubject=x;window.scrollToNote=N;window.toggleFeaturedSection=b;window.closeReportModal=()=>document.getElementById("reportModal").style.display="none";window.showReportModal=()=>document.getElementById("reportModal").style.display="block";window.closeImageModal=E;window.openImageModal=L;window.downloadImage=I;window.downloadImageFromUrl=w;window.notesManager=d;console.log("‚úÖ Functions Exposed");document.addEventListener("DOMContentLoaded",()=>{sessionStorage.getItem("hasSeenPromo")||setTimeout(()=>{const t=document.getElementById("promoModal");t&&t.classList.add("show")},1500)});function H(){const s=document.getElementById("promoModal");s&&(s.classList.remove("show"),sessionStorage.setItem("hasSeenPromo","true"))}window.closePromoModal=H;
