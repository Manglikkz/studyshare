class c{static show(e,t="info",s=3e3){const a=document.querySelector(".custom-alert");a&&a.remove();const n=document.createElement("div");n.className=`custom-alert custom-alert-${t}`;let o,r,l,m;switch(t){case"success":o="rgba(16, 185, 129, 0.1)",r="#10b981",l="#10b981",m="‚úì";break;case"error":o="rgba(239, 68, 68, 0.1)",r="#ef4444",l="#ef4444",m="‚úó";break;case"warning":o="rgba(245, 158, 11, 0.1)",r="#f59e0b",l="#f59e0b",m="‚ö†";break;default:o="rgba(74, 144, 226, 0.1)",r="#4a90e2",l="#4a90e2",m="‚Ñπ";break}return n.style.cssText=`
            position: fixed; top: 20px; right: 20px; background: ${o}; color: ${r}; border: 1px solid ${l};
            padding: 16px 20px; border-radius: 12px; display: flex; align-items: center; gap: 12px; z-index: 9999;
            backdrop-filter: blur(10px); box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15); max-width: 400px;
            animation: slideInRight 0.3s ease-out; transition: all 0.3s ease;
        `,n.innerHTML=`
            <span class="alert-icon" style="font-size: 1.2rem;">${m}</span>
            <span class="alert-message">${e}</span>
            <button class="alert-close" style="background: none; border: none; color: ${r}; font-size: 1.5rem; cursor: pointer; margin-left: auto; padding: 0; line-height: 1;">√ó</button>
        `,document.body.appendChild(n),n.querySelector(".alert-close").addEventListener("click",()=>{n.style.animation="slideOutRight 0.3s ease-out",setTimeout(()=>n.remove(),300)}),s>0&&setTimeout(()=>{n.parentNode&&(n.style.animation="slideOutRight 0.3s ease-out",setTimeout(()=>n.remove(),300))},s),n}}class u{static show(e="Memproses..."){this.hide();const t=document.createElement("div");if(t.id="loading-spinner",t.style.cssText=`
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.9);
            display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; backdrop-filter: blur(5px);
        `,t.innerHTML=`
            <div class="spinner-container" style="text-align: center; padding: 2rem; border-radius: 20px; background: linear-gradient(135deg, rgba(74, 144, 226, 0.1) 0%, rgba(123, 184, 241, 0.1) 100%); border: 1px solid rgba(74, 144, 226, 0.2); box-shadow: 0 10px 30px rgba(74, 144, 226, 0.2);">
                <div class="spinner" style="width: 60px; height: 60px; border: 4px solid rgba(74, 144, 226, 0.1); border-top: 4px solid #4a90e2; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
                <p style="color: #4a90e2; font-size: 1.1rem; font-weight: 500; margin: 0;">${e}</p>
            </div>
        `,document.body.appendChild(t),!document.querySelector("#spinner-animation")){const s=document.createElement("style");s.id="spinner-animation",s.textContent="@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } } @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } } @keyframes slideOutRight { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }",document.head.appendChild(s)}}static hide(){const e=document.getElementById("loading-spinner");e&&(e.style.animation="fadeOut 0.3s ease-out",setTimeout(()=>e.remove(),300))}}const g={formatDate(i){try{return new Date(i).toLocaleDateString("id-ID",{day:"numeric",month:"long",year:"numeric",hour:"2-digit",minute:"2-digit"})}catch{return""}},createNoteCard(i){const e=d.getLikeStatus(i.id),t=d.getComments(i.id),s=document.createElement("div");s.className="note-card",s.setAttribute("data-note-id",i.id);let a="";return i.image&&(a+=`
                <div class="note-media">
                    <img src="${i.image}" alt="Foto catatan" class="note-image" onclick="openImageModal('${i.image}')">
                    <div class="image-actions">
                        <button class="image-action-btn" onclick="openImageModal('${i.image}')" title="Lihat gambar">üîç</button>
                        <button class="image-action-btn" onclick="downloadImageFromUrl('${i.image}', '${i.title}.jpg')" title="Download gambar">‚¨áÔ∏è</button>
                    </div>
                </div>
            `),s.innerHTML=`
            <div class="note-header">
                <h3 class="note-title">${this.escapeHtml(i.title)}</h3>
                <span class="subject-tag">${this.getSubjectName(i.subject)}</span>
            </div>
            <div class="note-content">${this.escapeHtml(i.content)}</div>
            ${a}
            <div class="note-meta">
                <span class="author">${this.escapeHtml(i.author)}</span>
                <span class="date">${this.formatDate(i.date)}</span>
            </div>
            <div class="like-dislike">
                <button class="like-btn ${e.liked?"active":""}" data-note-id="${i.id}" onclick="handleLike('${i.id}')">
                    üëç Like <span class="like-count">${i.likes}</span>
                </button>
                <button class="dislike-btn ${e.disliked?"active":""}" data-note-id="${i.id}" onclick="handleDislike('${i.id}')">
                    üëé Dislike <span class="dislike-count">${i.dislikes}</span>
                </button>
            </div>
            <div class="comments-section">
                <h4>Komentar (${t.length})</h4>
                <div class="comments-list">
                    ${t.map(n=>`<div class="comment"><p><strong>${this.escapeHtml(n.author)}:</strong> ${this.escapeHtml(n.text)}</p><small>${this.formatDate(n.date)}</small></div>`).join("")}
                </div>
                <div class="comment-input-group">
                    <input type="text" class="comment-author" placeholder="Nama Anda" required>
                    <div class="comment-form-container">
                        <input type="text" placeholder="Tulis komentar..." class="comment-input">
                        <button class="comment-submit" onclick="handleAddComment('${i.id}', this)">Kirim</button>
                    </div>
                </div>
            </div>
        `,s},getSubjectName(i){return{"bahasa-arab":"Bahasa Arab",nahwu:"Nahwu",shorof:"Shorof",tahfidz:"Tahfidz",tahsin:"Tahsin",aqidah:"Aqidah",fikih:"Fikih",hadits:"Hadits","adab-akhlaq":"Adab & Akhlaq","bahasa-inggris":"Bahasa Inggris",matematika:"Matematika",bootcamp:"Bootcamp"}[i]||i},escapeHtml(i){if(!i)return"";const e=document.createElement("div");return e.textContent=i,e.innerHTML},renderNoteOfTheDay(i){const e=document.getElementById("noteOfDayContainer");if(!e)return;if(!i){e.innerHTML='<div class="noteday-card"><p class="empty">Belum ada catatan.</p></div>';return}const t=d.getComments(i.id);e.innerHTML=`
        <div class="noteday-card">
            <div class="noteday-header">
                <span class="subject-tag large">${this.getSubjectName(i.subject)}</span>
                <span class="date">${this.formatDate(i.date)}</span>
            </div>
            <h3>${this.escapeHtml(i.title)}</h3>
            
            <!-- Menggunakan class note-content agar format baris baru terbaca -->
            <div class="note-content full-text">${this.escapeHtml(i.content)}</div>
            
            <div class="noteday-stats">
                <span>üëç ${i.likes}</span>
                <span>üí¨ ${t.length}</span>
                <span>‚úçÔ∏è ${this.escapeHtml(i.author)}</span>
            </div>
            <button class="btn-primary" onclick="scrollToNote('${i.id}')">Lihat Lengkap</button>
        </div>
    `},renderTrendingSection(i){const e=document.getElementById("trendingContainer");if(e){if(i.length===0){e.innerHTML='<p class="empty">Belum ada catatan trending.</p>';return}e.innerHTML=i.map(t=>`
            <div class="trending-item" onclick="scrollToNote('${t.id}')">
                <h4>${this.escapeHtml(t.title.substring(0,40))}...</h4>
                <div class="trending-meta"><span>${this.getSubjectName(t.subject)}</span><span>üëç ${t.likes}</span></div>
            </div>
        `).join("")}},renderCategories(){const i=document.getElementById("categoriesContainer");if(!i)return;const e=d.getCategories();if(e.length===0){i.innerHTML='<p class="empty">Belum ada kategori.</p>';return}i.innerHTML=e.map(t=>`
            <div class="category-card" data-subject="${t.id}" onclick="filterBySubject('${t.id}')">
                <div class="category-icon">${t.name.charAt(0)}</div><h4>${t.name}</h4><p>${t.count} catatan</p>
            </div>
        `).join("")},renderActivityFeed(i){const e=document.getElementById("activityFeed");if(e){if(i.length===0){e.innerHTML='<p class="empty">Belum ada aktivitas.</p>';return}e.innerHTML=i.map(t=>`<div class="activity-item"><span>${t.text}</span><small>${t.timeAgo}</small></div>`).join("")}},renderNotes(i,e){e.innerHTML="";const t=document.getElementById("noNotes");if(i.length===0){t&&(t.style.display="block");return}t&&(t.style.display="none"),i.forEach(s=>{e.appendChild(this.createNoteCard(s))})}};class b{constructor(){this.notes=[],this.likes={},this.comments={},this.userLikes={},this.supabaseService=null,this.initialized=!1,this.init()}async init(){console.log("üìö Initializing NotesManager..."),typeof u<"u"&&u.show("Menghubungkan ke server..."),await this.waitForSupabaseClient(),this.supabaseService?(console.log("‚úÖ Supabase client ready, attempting to fetch data..."),await this.fetchWithRetry()):(console.warn("‚ö†Ô∏è Supabase not available, using empty mode."),this.notes=[],this.initialized=!0,typeof u<"u"&&u.hide())}async waitForSupabaseClient(){return new Promise(e=>{let t=0;const s=100,a=()=>{window.supabaseService&&window.supabaseService.client?(this.supabaseService=window.supabaseService,e(!0)):t<s?(t++,setTimeout(a,100)):e(!1)};a()})}async fetchWithRetry(){let e=0;const t=5;let s=!1;for(;e<t&&!s;)try{if(e>0&&typeof u<"u"){const n=document.querySelector("#loading-spinner p");n&&(n.textContent=`Membangunkan database... (${e}/${t})`)}if(console.log(`üîÑ Percobaan fetch data ke-${e+1}...`),await this.supabaseService.checkConnection())await this.loadFromSupabase(),s=!0,console.log("‚úÖ Data berhasil diambil!");else throw new Error("Database belum siap")}catch{console.warn(`‚ö†Ô∏è Percobaan ${e+1} gagal.`),e++,e<t&&await new Promise(n=>setTimeout(n,1500))}this.initialized=!0,typeof u<"u"&&u.hide(),h(),!s&&typeof c<"u"&&c.show("Koneksi lambat. Refresh jika data kosong.","warning",5e3)}async loadFromSupabase(){const e=await this.supabaseService.getNotes();if(!e){this.notes=[];return}this.notes=e.map(t=>({id:t.id,title:this.sanitizeHTML(t.title||""),subject:this.sanitizeHTML(t.subject||"other"),content:this.sanitizeHTML(t.content||""),author:this.sanitizeHTML(t.author||"Anonim"),date:t.created_at||new Date().toISOString(),likes:t.likes_count||0,dislikes:t.dislikes_count||0,image:t.image_url||null})),await this.loadAdditionalData()}async loadAdditionalData(){if(!this.supabaseService||!this.supabaseService.isConnected)return;const e=this.notes.map(async t=>{try{const[s,a]=await Promise.all([this.supabaseService.getLikes(t.id),this.supabaseService.getComments(t.id)]),n=this.getUserId(),o=s.find(r=>r.user_id===n);this.likes[t.id]={liked:o?.type==="like",disliked:o?.type==="dislike",count:t.likes||0,dislikes:t.dislikes||0},this.userLikes[t.id]=this.userLikes[t.id]||{},this.userLikes[t.id][n]=o?o.type:"none",this.comments[t.id]=a.map(r=>({id:r.id,author:this.sanitizeHTML(r.author||"Anonim"),text:this.sanitizeHTML(r.text||""),date:r.created_at}))}catch{this.likes[t.id]={liked:!1,disliked:!1,count:t.likes||0,dislikes:t.dislikes||0},this.comments[t.id]=[]}});await Promise.allSettled(e)}sanitizeHTML(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}escapeHtml(e){return this.sanitizeHTML(e)}getUserId(){let e=localStorage.getItem("user_id");return e||(e="user_"+Math.random().toString(36).substr(2,9),localStorage.setItem("user_id",e)),e}getNoteOfTheDay(){if(this.notes.length===0)return null;const e=new Date().toDateString().split("").reduce((s,a)=>s+a.charCodeAt(0),0),t=this.getFilteredAndSortedNotes("all","likes");return t[e%Math.max(1,t.length)]}getTrendingNotes(e=5){const t=Date.now(),s=1440*60*1e3;return this.notes.filter(a=>new Date(a.date)>new Date(t-s)).map(a=>({...a,score:a.likes*.7+(this.comments[a.id]?.length||0)*.3})).sort((a,n)=>n.score-a.score).slice(0,e).concat(this.notes.slice(0,e)).slice(0,e)}getCategories(){return[{id:"matematika",name:"Matematika"},{id:"bahasa-inggris",name:"Bahasa Inggris"},{id:"bahasa-arab",name:"Bahasa Arab"},{id:"fikih",name:"Fikih"},{id:"aqidah",name:"Aqidah"},{id:"hadits",name:"Hadits"},{id:"adab-akhlaq",name:"Adab & Akhlaq"},{id:"nahwu",name:"Nahwu"},{id:"shorof",name:"Shorof"},{id:"tahfidz",name:"Tahfidz"},{id:"tahsin",name:"Tahsin"},{id:"bootcamp",name:"Bootcamp"}].map(t=>({...t,count:this.notes.filter(s=>s.subject===t.id).length})).filter(t=>t.count>0)}getRecentActivity(e=5){const t=[];return this.notes.slice(0,10).forEach(s=>{t.push({type:"upload",text:`Catatan baru: "${s.title.substring(0,30)}..."`,time:new Date(s.date).getTime(),noteId:s.id});const a=this.comments[s.id]?.[this.comments[s.id].length-1];a&&t.push({type:"comment",text:`Komentar di "${s.title.substring(0,20)}..."`,time:new Date(a.date).getTime(),noteId:s.id})}),t.sort((s,a)=>a.time-s.time).slice(0,e).map(s=>({...s,timeAgo:this.getTimeAgo(Date.now()-s.time)}))}getTimeAgo(e){const t=Math.floor(e/1e3),s=Math.floor(t/60),a=Math.floor(s/60),n=Math.floor(a/24);return n>0?`${n} hari lalu`:a>0?`${a} jam lalu`:s>0?`${s} menit lalu`:`${t} detik lalu`}getTotalSubjects(){return new Set(this.notes.map(e=>e.subject)).size}getTotalNotes(){return this.notes.length}async addNote(e,t,s,a="Anonim",n=null){const o={title:this.sanitizeHTML(e.trim()),subject:t,content:this.sanitizeHTML(s.trim()),author:this.sanitizeHTML(a.trim())||"Anonim",date:new Date().toISOString(),likes:0,dislikes:0,image:n};if(this.supabaseService&&this.supabaseService.isConnected){const r=await this.supabaseService.addNote(o);return o.id=r.id,this.notes.unshift(o),o}else throw new Error("Tidak terhubung ke server")}getLikeStatus(e){const t=this.getUserId(),s=this.userLikes[e]?.[t]||"none",a=this.notes.find(n=>n.id===e);return{liked:s==="like",disliked:s==="dislike",count:a?.likes||0,dislikes:a?.dislikes||0}}async toggleLike(e){const t=this.notes.find(o=>o.id===e);if(!t)return null;const s=this.getUserId(),a=this.getLikeStatus(e);a.liked?(t.likes--,delete this.userLikes[e][s]):(a.disliked&&t.dislikes--,t.likes++,this.userLikes[e]=this.userLikes[e]||{},this.userLikes[e][s]="like");const n=this.getLikeStatus(e);if(this.likes[e]=n,this.supabaseService?.isConnected)try{await this.supabaseService.toggleLike(e,s,"like"),await this.supabaseService.updateNoteStats(e,t.likes,t.dislikes),c.show(a.liked?"Like dihapus":"Liked!","success",2e3)}catch{c.show("Gagal sinkron","warning")}return n}async toggleDislike(e){const t=this.notes.find(o=>o.id===e);if(!t)return null;const s=this.getUserId(),a=this.getLikeStatus(e);a.disliked?(t.dislikes--,delete this.userLikes[e][s]):(a.liked&&t.likes--,t.dislikes++,this.userLikes[e]=this.userLikes[e]||{},this.userLikes[e][s]="dislike");const n=this.getLikeStatus(e);if(this.likes[e]=n,this.supabaseService?.isConnected)try{await this.supabaseService.toggleLike(e,s,"dislike"),await this.supabaseService.updateNoteStats(e,t.likes,t.dislikes),c.show(a.disliked?"Dislike dihapus":"Disliked!","success",2e3)}catch{c.show("Gagal sinkron","warning")}return n}getComments(e){return this.comments[e]||[]}async addComment(e,t,s="Anonim"){this.comments[e]||(this.comments[e]=[]);const a={noteId:e,author:this.sanitizeHTML(s.trim())||"Anonim",text:this.sanitizeHTML(t.trim()),date:new Date().toISOString()};if(this.supabaseService?.isConnected){const n=await this.supabaseService.addComment(a);a.id=n.id,this.comments[e].push(a),c.show("Komentar terkirim!","success",2e3)}else throw new Error("Offline");return a}getFilteredAndSortedNotes(e="all",t="likes"){let s=[...this.notes];return e!=="all"&&(s=s.filter(a=>a.subject===e)),t==="likes"?s.sort((a,n)=>n.likes-a.likes):t==="recent"?s.sort((a,n)=>new Date(n.date)-new Date(a.date)):t==="oldest"&&s.sort((a,n)=>new Date(a.date)-new Date(n.date)),s}isInitialized(){return this.initialized}async refreshData(){return this.fetchWithRetry()}}const d=new b;let f="";function w(i){f=i,document.getElementById("modalImage").src=i,document.getElementById("imageModal").classList.add("show"),document.body.style.overflow="hidden"}function v(){document.getElementById("imageModal").classList.remove("show"),document.body.style.overflow=""}function S(){f&&y(f)}function y(i,e="download.jpg"){const t=document.createElement("a");t.href=i,t.download=e,document.body.appendChild(t),t.click(),document.body.removeChild(t)}async function L(){u.show("Menyinkronkan data...");try{await d.refreshData(),c.show("Data disinkronkan!","success")}catch{c.show("Gagal sinkronisasi","error")}}async function M(i){await d.toggleLike(i)&&h()}async function I(i){await d.toggleDislike(i)&&h()}async function E(i,e){const t=e.closest(".comment-input-group"),s=t.querySelector(".comment-author").value,a=t.querySelector(".comment-input").value;if(!s||!a)return c.show("Isi nama dan komentar!","warning");try{await d.addComment(i,a,s),h(),t.querySelector(".comment-input").value=""}catch(n){c.show(n.message,"error")}}function T(i){const e=document.getElementById("subjectFilter");e&&(e.value=i,h(),document.getElementById("notesContainer").scrollIntoView({behavior:"smooth"}))}function B(i){const e=document.querySelector(`[data-note-id="${i}"]`);e&&(e.scrollIntoView({behavior:"smooth"}),e.style.animation="none",setTimeout(()=>e.style.animation="fadeIn 0.5s ease",10))}function $(){const i=document.getElementById("fileUploadArea"),e=document.getElementById("noteImage"),t=document.getElementById("imagePreview"),s=document.getElementById("uploadPlaceholder"),a=document.getElementById("removeImageBtn");!i||!e||(e.addEventListener("change",n=>{const o=n.target.files[0];if(o){if(o.size>5*1024*1024){c.show("Ukuran file terlalu besar! Maksimal 5MB.","warning"),e.value="";return}const r=new FileReader;r.onload=l=>{t.innerHTML=`<img src="${l.target.result}" alt="Preview">`,t.style.display="flex",s.style.display="none",a&&(a.style.display="block")},r.readAsDataURL(o)}}),a&&a.addEventListener("click",()=>{e.value="",t.innerHTML="",t.style.display="none",s.style.display="block",a.style.display="none"}))}function C(i,e=800,t=.7){return new Promise((s,a)=>{const n=new FileReader;n.readAsDataURL(i),n.onload=o=>{const r=new Image;r.src=o.target.result,r.onload=()=>{const l=document.createElement("canvas");let m=r.width,p=r.height;m>e&&(p=Math.round(p*e/m),m=e),l.width=m,l.height=p,l.getContext("2d").drawImage(r,0,0,m,p),s(l.toDataURL("image/jpeg",t))},r.onerror=l=>a(l)},n.onerror=o=>a(o)})}async function x(i){i.preventDefault();const e=document.getElementById("noteTitle").value,t=document.getElementById("noteSubject").value,s=document.getElementById("noteContent").value,a=document.getElementById("authorName").value,n=document.getElementById("noteImage"),o=n?n.files[0]:null;if(!e||!t||!s||!a)return c.show("Harap isi Judul, Mata Pelajaran, Konten, dan Nama Penulis!","warning");u.show("Mengompres & Mengupload...");try{let r=null;if(o){if(o.size>4*1024*1024)throw new Error("Ukuran file terlalu besar! Maksimal 4MB.");r=await C(o,800,.7)}await d.addNote(e,t,s,a,r),u.hide(),c.show("Berhasil upload!","success");const l=document.getElementById("uploadSuccess");l&&l.classList.add("show"),i.target.reset(),document.getElementById("imagePreview").style.display="none",document.getElementById("uploadPlaceholder").style.display="block";const m=document.getElementById("removeImageBtn");m&&(m.style.display="none")}catch(r){u.hide(),console.error("Upload Error:",r),c.show("Gagal Upload: "+r.message,"error")}}function h(){const i=document.getElementById("notesContainer");if(i&&d.isInitialized()){const e=document.getElementById("subjectFilter")?.value||"all",t=document.getElementById("sortFilter")?.value||"likes",s=d.getFilteredAndSortedNotes(e,t);g.renderNotes(s,i),D()}else setTimeout(h,500)}function D(){const i=document.getElementById("totalNotesCount");i&&(i.textContent=d.getTotalNotes());const e=document.getElementById("totalSubjectsCount");e&&(e.textContent=d.getTotalSubjects()),g.renderNoteOfTheDay(d.getNoteOfTheDay()),g.renderTrendingSection(d.getTrendingNotes()),g.renderCategories(),g.renderActivityFeed(d.getRecentActivity())}function H(){document.getElementById("subjectFilter")&&(document.getElementById("subjectFilter").value="all"),document.getElementById("sortFilter")&&(document.getElementById("sortFilter").value="likes"),h()}function k(){const i=document.getElementById("featuredSection");i.style.display==="none"?(i.style.display="block",i.classList.add("show")):(i.style.display="none",i.classList.remove("show"))}document.addEventListener("DOMContentLoaded",()=>{console.log("üöÄ App Loaded"),document.getElementById("notesContainer")&&(document.getElementById("subjectFilter")?.addEventListener("change",h),document.getElementById("sortFilter")?.addEventListener("change",h),document.getElementById("featuredMenuBtn")?.addEventListener("click",k),h());const i=document.getElementById("uploadForm");i&&(i.addEventListener("submit",x),$())});window.forceRefreshAll=L;window.resetFilters=H;window.handleLike=M;window.handleDislike=I;window.handleAddComment=E;window.filterBySubject=T;window.scrollToNote=B;window.toggleFeaturedSection=k;window.closeReportModal=()=>document.getElementById("reportModal").style.display="none";window.showReportModal=()=>document.getElementById("reportModal").style.display="block";window.closeImageModal=v;window.openImageModal=w;window.downloadImage=S;window.downloadImageFromUrl=y;window.notesManager=d;console.log("‚úÖ Functions Exposed");document.addEventListener("DOMContentLoaded",()=>{sessionStorage.getItem("hasSeenPromo")||setTimeout(()=>{const e=document.getElementById("promoModal");e&&e.classList.add("show")},1500)});function N(){const i=document.getElementById("promoModal");i&&(i.classList.remove("show"),sessionStorage.setItem("hasSeenPromo","true"))}window.closePromoModal=N;
